version: '3'

# https://taskfile.dev/usage/#env-files
dotenv: [ '.env.local', '.env' ]

vars:
  # https://taskfile.dev/reference/templating/
  BASE_URL: '{{.TASK_BASE_URL | default .COMPOSE_SERVER_DOMAIN | default .COMPOSE_DOMAIN }}'
  DOCKER_COMPOSE: '{{ .TASK_DOCKER_COMPOSE | default "itkdev-docker-compose" }}'
  OPEN_WEBUI_REPO: 'https://github.com/itk-dev/open-webui.git'
  OPEN_WEBUI_PREV_VERSION: 'v0.6.32'
  OPEN_WEBUI_VERSION: 'v0.6.33'
  PROD_OPEN_WEBUI_VERSION: 'v0.6.33-1'
  TARGET_DIR: 'open-webui'
  PATCHES:
    - name: 'Frontend changes - login banner and sidebar logo'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/42.diff'
      branch: 'feature/front-end-ii'
    - name: 'Pinned info banner'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/32.diff'
      branch: 'feature/pinned-info-banner'
    - name: 'OIDC aak roles and groups'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/33.diff'
      branch: 'feature/oidc-group-claims'
    - name: 'Ensured that role names from OIDC is kept'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/34.diff'
      branch: 'feature/keep-role-names'
    - name: 'Add token to TTS requests'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/38.diff'
      branch: 'feature/tts-token'
    - name: 'Extra permissions'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/40.diff'
      branch: 'feature/extra-permissions'
    - name: 'Allow only admin users to generate API-KEY for the backend'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/41.diff'
      branch: 'feature/admin-api-keys'
    - name: 'Fixed null error in auth database session handling'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/43.diff'
      branch: 'feature/oauth_token_expire'
    - name: 'Expose file metadata URL in citation modal'
      url: 'https://patch-diff.githubusercontent.com/raw/itk-dev/open-webui/pull/44.diff'
      branch: 'feature/citation-modal-url'
    # Patches upstream
    - name: 'Fix search model drop-down'
      url: 'https://patch-diff.githubusercontent.com/raw/open-webui/open-webui/pull/17960.diff'
    # 0.6.33 patches
    - name: 'Fixed RAG'
      url: 'https://github.com/open-webui/open-webui/commit/c4832fdb7033e6787961e21eb81e2671519cf87d.diff'

tasks:
  default:
    desc: 'List all tasks'
    cmds:
      - task --list-all
    silent: true

  compose:
    desc: "Run `docker compose` command. Example: task compose -- up --detach"
    cmds:
      - '{{ .DOCKER_COMPOSE }} {{ .CLI_ARGS }}'

  ####
  ## Git helpers
  ####
  git:sync:tags:
    desc: "Sync tags from upstream repos"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - |
        echo "This assumes that you already have synced the main and dev branches with upstream on github!"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Sync cancelled."
          exit 1
        fi
      - git remote add upstream https://github.com/open-webui/open-webui
      - git fetch --tags upstream
      - git push --tags
      - git remote rm upstream
    silent: true

  git:clone:
    desc: "Clone open-webui core"
    cmds:
      - git clone {{ .OPEN_WEBUI_REPO }}
      - git checkout {{ .OPEN_WEBUI_VERSION }}
    silent: true

  git:checkout:dev:
    desc: "Checkout open-webui dev branch"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - git reset --hard
      - git checkout .
      - git checkout dev
    silent: true

  git:reset:
    desc: "Reset open-webui checkout to a specific version"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - git reset --hard
      - git checkout .
      - git checkout {{ .OPEN_WEBUI_VERSION }}
    silent: true

  ####
  ## Install and setup (local helpers)
  ####
  patch:
    desc: "Patch open-webui with custom patches"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - for: { var: PATCHES }
        cmd: curl -sSL {{ .ITEM.url }} | patch -p1 --no-backup-if-mismatch
    silent: false

  install:
    desc: "Install new web-ui"
    cmds:
      - |
        echo "This will reset all changes and install a new version of open-webui:"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Install cancelled."
          exit 1
        fi
      - task git:reset
      - task patch
      - task copy:config
      - task compose -- pull
      - task compose -- up --detach --force-recreate
      - task wui:frontend:build
    silent: true

  open:
    desc: "Open-webui in the browser"
    cmds:
      - open http://{{ .BASE_URL }}
    silent: true

  copy:config:
    desc: "Copy config file from example, if it does not exist"
    cmds:
      - if ! [ -f litellm_config.yaml ]; then cp litellm_config.example.yaml litellm_config.yaml; fi
      - if ! [ -f .env ]; then cp .env.default .env; fi
    silent: true

  wui:backend:build:
    desc: "Build container with newest requirements"
    cmds:
      - task compose -- build --pull
    silent: true

  wui:frontend:build:
    desc: "Build frontend"
    cmds:
      - task compose -- run --rm -it node npm ci --force
      - task compose -- run --rm -it node npm run build
    silent: true

  wui:frontend:dev:build:
    desc: "Build frontend with enviroment set to dev"
    cmds:
      - task compose -- run --rm -it -e ENV=dev node npm ci --force
      - task compose -- run --rm -it -e ENV=dev node npm run build
    silent: true

  ####
  ## Update webui version helpers (<-- danger zone -->)
  ####
  patches:rebase:
    desc: "Rebase patch to laste release"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - |
        echo "This will rebase all patches to open-webui {{ .OPEN_WEBUI_VERSION }} from {{ .OPEN_WEBUI_PREV_VERSION }}:"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Install cancelled."
          exit 1
        fi
      - for: { var: PATCHES }
        cmd: |
          if [ -n "{{ .ITEM.branch }}" ]; then
            echo "Processing patch: {{ .ITEM.name }}"
            git checkout {{ .ITEM.branch }}
            git pull
            git rebase --onto upstream/{{ .OPEN_WEBUI_VERSION }} upstream/{{ .OPEN_WEBUI_PREV_VERSION }}
          else
            echo "No branch specified for this '{{ .ITEM.name }}', skipping rebase"
          fi
      - git checkout upstream/{{ .OPEN_WEBUI_VERSION }}
    silent: true

  patches:reset:
    desc: "Rest patch branched to GitHub version"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - |
        echo "This will reset all patches to open-webui to current version on Github:"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Install cancelled."
          exit 1
        fi
      - for: { var: PATCHES }
        cmd: |
          if [ -n "{{ .ITEM.branch }}" ]; then
            echo "Resetting patch: {{ .ITEM.name }}"
            git checkout {{ .ITEM.branch }}
            git reset --hard origin/{{ .ITEM.branch }}
            git pull
          else
            echo "No branch specified for this '{{ .ITEM.name }}', skipping rebase"
          fi
      - git checkout upstream/{{ .OPEN_WEBUI_VERSION }}
    silent: true

  patches:force:
    desc: "Force push all patches branches"
    dir: "{{ .TARGET_DIR }}"
    cmds:
      - |
        echo "This will force push all patches branches:"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Push cancelled."
          exit 1
        fi
      - for: { var: PATCHES }
        cmd: |
          if [ -n "{{ .ITEM.branch }}" ]; then
            git push origin {{ .ITEM.branch }} --force
          else
            echo "No branch specified for this '{{ .ITEM.name }}', skipping push"
          fi
    silent: true

  ####
  ## Production build
  ####
  prod:build:
    desc: Build docker image and push to docker hub
    cmds:
      - |
        echo "You are about to build and push production images:"
        echo "  - itkdev/openwebui:{{.PROD_OPEN_WEBUI_VERSION}}"
        echo "  - itkdev/openwebui:latest"
        echo ""
        read -p "Are you sure you want to continue? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Build cancelled."
          exit 1
        fi
      - task: prod:prepare
      - COMPOSE_BAKE=true docker compose --file docker-compose.yml build --no-cache --pull openwebui
      - docker tag openwebui-openwebui itkdev/openwebui:{{.PROD_OPEN_WEBUI_VERSION}}
      - docker tag openwebui-openwebui itkdev/openwebui:latest
      - docker push itkdev/openwebui:{{.PROD_OPEN_WEBUI_VERSION}}
      - docker push itkdev/openwebui:latest
    silent: true

  prod:prepare:
    desc: "Prepare production build - reset git, patch"
    internal: true
    cmds:
      - task git:reset
      - task patch
